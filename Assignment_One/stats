#!/bin/bash

# Program 1
# Author: Alexander Miranda
# Due Date: 10/09/2017
# Term: Fall 2017

# This program will compute the average and median from numbers
# supplied by a file or stdin. The program accepts a flag argument
# which specifies if the calculations are done per row or per column.

# Storing tmp file variable with pid appended
TMP=tmp$$

trap "rm -f $TMP*; exit 1" INT HUP TERM

trap "rm -f $TMP*" EXIT

instructions () {
	echo "$0 {-rows | -cols} [filename]" 1>&2
}

# Check if the user provided the proper amount of arguments
# will output the proper usage and will exit otherwise
if [[ $# < 1 || $# > 2 ]]; then
	instructions
	exit 1
fi

if [[ ! -z $2 && ! -r $2 ]]; then
	echo "$0: cannot read $2" 1>&2
	exit 1
fi

if [[ $1 == -r* ]]; then
	printf "Average\tMedian\n"

	while read line
	do
		sum=0
		count=0
		average=0
		median=0

		sorted_line=$(echo $line | tr " " "\n" | sort -g) 

		for i in $sorted_line
		do
			num=$i
			count=`expr $count + 1`
			sum=`expr $sum + $num`
		done

		mid_point=`expr $[ $count / 2 ] + 1`

		for num in $sorted_line
		do
			median=$num
			if [ $mid_point -le 1 ] 
			then
				break
			else
				mid_point=`expr $mid_point - 1`
			fi
		done

		average=`expr $sum / $count`
		printf "$average\t$median\n"
	done < "${2:-/dev/stdin}"
elif [[ $1 == -c* ]]; then
	
	column_count=$(egrep ".{$(expand -t 1 ${2:-/dev/stdin} | wc -L)}" ${2:-dev/stdin} | head -n 1 | wc -w )

	for (( i=1; i <= column_count; i++)); do
		while read line; do
			local num=$(expand -t 1 <<< $line | cut -d$' ' -f$i )
			[ $(wc -w <<< $line) -ge $i ] && echo $num >> "${TMP}"
		done < "${2:-/dev/stdin}"
		
	done
else
	instructions
	exit 1
fi
